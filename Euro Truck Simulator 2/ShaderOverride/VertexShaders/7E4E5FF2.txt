// Sun & bloom around lights

    vs_3_0
    dcl_position v0
    dcl_color v1
    dcl_texcoord v2
    dcl_position o0
    dcl_color o1
    dcl_texcoord o2.xyz
    dcl_texcoord1 o3.xy

def c220, 0, 1, 0.0625, 4

// depth bounds:
def c221, 4, 6, 0, 0

// texcoord filter (no good):
def c222, 0, 1, 0, 1

// Colour filter:
def c223, 0.6, 0.2, 0.1, 1.0 // Red really can't go lower :(
def c224, 1.2, 1.1, 0.8, 1.1

dcl_2d s3

    dp4 r10.x, v0, c0
    dp4 r10.y, v0, c1
    dp4 r10.z, v0, c2
    dp4 r10.w, v0, c3
    dp4 o2.x, v0, c4
    dp4 o2.y, v0, c5
    dp4 o2.z, v0, c6
    mad o3.xy, v2, c7.x, c7.y
    mov o1, v1

// approximately 9 instruction slots used

texldl r31, c220.z, s3

// Move sun to infinity. Shader also affects car headlights (and can't filter
// on texture or pixel shader), so...

// Attempt 1 - check the depth. Reliable for sun, but still affects headlights
// at certain depths (easiest to see - put truck in reverse, use exterior cam
// and zoom):

if_ge r10.w, c221.x
if_le r10.w, c221.y

	// Attempt 3 - check the colour:

	sge r28, v1, c223
	slt r29, v1, c224
	min r30, r28, r29
	dp4 r30.x, r30, c220.y
	if_eq r30.x, c220.w
	//if_eq r28.x, c220.y // Use to test individual components
		mad r10.x, r31.x, r31.y, r10.x
	endif

endif
endif
mov o0, r10
